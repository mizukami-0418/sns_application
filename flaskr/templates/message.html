{% from "_formhelpers.html" import render_field %}
{% extends "base.html" %}
{% block title %}
メッセージ画面 - {{ super() }}
{% endblock %}
{% block content %}
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script>
  $(function(){
    // 5秒間隔でget_new_messagesを実行
    let timer = setInterval(get_new_messages, 5000);
    // 初期表示で画面の一番下を表示
    let scroll = (document.scrollingElement || document.body);
    scroll.scrollTop = scroll.scrollHeight;
  });
  let user_id = "{{ to_user_id }}";
  function get_new_messages(){
    $.getJSON("/message_ajax", {
      user_id: user_id
    }, function(data){
      $('#message-form').before(data['data']);
      let checked_message_ids = data['checked_message_ids']
      for(let idx = 0; idx < checked_message_ids.length; idx++){
        $('#self-message-tag-' + checked_message_ids[idx]).append('<p class="text-end">既読</p>')
      }
    });
  };
</script>
<div class="row">
  {% for message in messages %}
    {% if message.from_user_id == current_user.id %}
    <div id="self-message-tag-{{message.id}}" class="col-lg-1 offset-lg-6 col-md-1 offset-md-3 col-sm-2 offset-sm-2 col-2 offset-2">
      {% if message.is_checked %} {# 既読メッセージにチェック済 #}
      <p class="text-end">既読</p>
      {% endif %}
    </div>
    <div class="speech-bubble-self col-lg-4 col-md-7 col-sm-6 col-6">
      {% for splitted_message in message.message | replace_newline %}
        <p>{{ splitted_message | urlize }}</p>
      {% endfor %}
    </div>
    <div class="col-lg-1 col-md-1 col-sm-2 col-2">
      {% if current_user.picture_path %}
        <img class="user-image-mini" src="{{ url_for('static', filename=current_user.picture_path) }}">
      {% endif %}
      <p>{{ current_user.username }}</p>
    </div>
    {% else %}
    <div class="col-lg-1 col-md-1 col-sm-2 col-2">
      {% if user.picture_path %}
        <img class="user-image-mini" src="{{ url_for('static', filename=user.picture_path) }}">
      {% endif %}
      <p>{{ user.username }}</p>
    </div>
    <div class="speech-bubble-dest col-lg-4 col-md-7 col-sm-6 col-6">
      {% for splitted_message in message.message | replace_newline %}
        <p>{{ splitted_message | urlize }}</p>
      {% endfor %}
    </div>
    <div class="col-lg-7 col-md-3 col-sm-4 col-4"></div>
    {% endif %}
  {% endfor %}
  <div id="message-form" class="col-lg-3 offset-lg-6 col-md-6 offset-md-4 col-sm-10 col-10">
    <form method="POST">
      {{ form.csrf_token }}
      {{ form.to_user_id(value=to_user_id) }}
      {{ render_field(form.message, cols="50", rows="5") }}
      {{ form.submit()}}
    </form>
  </div>
</div>
{% endblock %}